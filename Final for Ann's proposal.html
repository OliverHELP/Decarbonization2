<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PAGE TITLE: Change this to whatever you like! -->
    <title>Energy Owl Dashboard</title>
    <!-- FONTS: Using Roboto and Nunito. You can explore others at fonts.google.com -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- COLOUR PALETTE VARIABLES (Easy to change!) --- */
        :root {
            --color-background: #e0f7fa; /* Light Cyan page background */
            --color-panel-bg: #ffffff;    /* White for main panels */
            --color-text-dark: #333333;
            --color-text-medium: #555555;
            --color-text-light: #777777;

            --color-source-panel-bg: #fffde7; /* Light Yellow for power source panel */
            --color-source-panel-border: #fdd835; /* Bright Yellow border */
            --color-source-block-bg: #fff9c4;
            --color-source-block-border: #fbc02d;
            --color-source-title: #d84315; /* Deep Orange for source titles */
            --color-source-icon: #f57f17;
            --color-source-line-gradient-start: #fdd835;
            --color-source-line-gradient-mid: #ffb300;
            --color-source-line-gradient-end: #fdd835;


            --color-available-panel-bg: #e1f5fe; /* Light Blue for available power panel */
            --color-available-panel-border: #4fc3f7; /* Bright Blue border */
            --color-available-title: #0277bd;
            --color-available-meter-text: #01579b;

            --color-circuit-panel-bg: #fce4ec; /* Light Pink for circuits panel */
            --color-circuit-panel-border: #f06292; /* Bright Pink border */
            --color-circuit-block-bg: #f9f9f9;
            --color-circuit-block-border: #e8e8e8;
            --color-circuit-title: #6a1b9a;
            --color-circuit-icon: #8e24aa; /* Purple for circuit icons */
            --color-circuit-line-gradient-start: #ffeb3b;
            --color-circuit-line-gradient-mid: #ffc107;
            --color-circuit-line-gradient-end: #ffeb3b;


            --color-device-block-bg: #dcedc8;
            --color-device-block-border: #a5d6a7;
            --color-device-title: #388e3c;

            --color-line-inactive: #78909c; /* Darker Grey Blue for inactive lines */
            --color-button-toggle-on: #66bb6a;
            --color-button-toggle-off: #ef5350;
            --color-button-neutral: #90a4ae;
            --color-button-remove: #78909c;
            --color-button-simulation: #ff9800;   /* Orange for simulation button */

            --font-primary: 'Roboto', sans-serif;
        }
        /* --- END COLOUR PALETTE --- */

        body {
            font-family: var(--font-primary);
            margin: 0; padding: 20px; background-color: var(--color-background);
            display: flex; justify-content: space-between; min-height: calc(100vh - 40px); gap: 20px;
        }

        .panel {
            background-color: var(--color-panel-bg); padding: 20px; border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-y: auto; position: relative;
            display: flex; flex-direction: column;
        }
        .panel h2 {
            color: var(--color-text-dark); text-align: center; font-weight: 700;
            border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0;
            font-size: 1.4em; flex-shrink: 0;
        }
        .panel-content { flex-grow: 1; overflow-y: auto; padding-right: 5px; }

        .power-sources-panel {
            width: 30%; background-color: var(--color-source-panel-bg);
            border-left: 8px solid var(--color-source-panel-border);
        }
        .power-sources-panel h2 { color: var(--color-source-title); }

        .power-available-panel {
            width: 20%; background-color: var(--color-available-panel-bg);
            border: 5px solid var(--color-available-panel-border);
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-around; /* Distribute space for owl */ text-align: center; z-index: 1;
        }
        .power-available-panel h3 { color: var(--color-available-title); font-size: 1.3em; margin-bottom: 5px; font-weight: 700;}
        .power-available-panel .meter-reading {
            font-size: 1.8em; font-weight: 700; color: var(--color-available-meter-text);
            padding: 6px 12px; background-color: var(--color-panel-bg);
            border-radius: 8px; box-shadow: inset 0 0 8px rgba(0,0,0,0.1); margin-bottom: 5px;
        }
        .power-available-panel p.description { font-size: 0.8em; color: var(--color-text-medium); margin-bottom: 10px;}
        /* Capacity Owl Styling */
        .capacity-owl-container {
            margin-top: 10px;
            text-align: center;
        }
        .capacity-owl {
            font-size: 3.5em; /* Large owl emoji */
            display: block;
            margin-bottom: 5px;
            transition: transform 0.3s ease-in-out;
        }
        .capacity-owl-status {
            font-size: 0.9em;
            font-weight: bold;
            color: var(--color-available-title);
        }
        /* CO2 Emissions Styling */
        .co2-emissions-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            width: 90%;
            box-sizing: border-box;
        }
        .co2-emissions-info h4 {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: var(--color-text-dark);
            font-weight: 500;
        }
        .co2-emissions-info p {
            font-size: 1.0em;
            font-weight: bold;
            color: var(--color-text-medium);
            margin: 0;
        }


        .circuits-panel {
            width: 46%; background-color: var(--color-circuit-panel-bg);
            border-right: 8px solid var(--color-circuit-panel-border);
        }
        .circuits-panel h2 { color: var(--color-circuit-title); }

        .block {
            padding: 12px; margin-bottom: 15px; border-radius: 8px;
            position: relative; box-shadow: 0 3px 6px rgba(0,0,0,0.07);
        }
        .power-source {
            background-color: var(--color-source-block-bg); border: 1px solid var(--color-source-block-border);
        }
        .power-source.off { opacity: 0.65; background-color: #eeeeee; }
        .power-source.off h3 { color: var(--color-text-light); }
        .power-source-icon { font-size: 1.8em; display: block; text-align: center; margin-bottom: 3px; color: var(--color-source-icon); }
        .power-source h3 { color: var(--color-source-title); }
        .power-source p { font-size: 0.9em; color: var(--color-text-medium); margin-bottom: 8px;}
        .power-source p.capacity-info { font-weight: 500; text-align: center; margin-bottom: 5px;}
        .power-source p.sustainability-info { font-size: 0.8em; color: var(--color-text-dark); text-align: center; font-style: italic; margin-bottom: 8px;}

        .circuit {
            background-color: var(--color-circuit-block-bg); border: 1px solid var(--color-circuit-block-border);
        }
        .circuit .circuit-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .circuit-icon {
            font-size: 1.5em; /* Slightly larger than device icons */
            margin-right: 10px;
            color: var(--color-circuit-icon);
        }
        .circuit h3 {
            color: var(--color-circuit-title);
            margin: 0; /* Remove default margin if icon is next to it */
            flex-grow: 1; /* Allow title to take remaining space */
        }
        .circuit p { font-size: 0.9em; color: var(--color-text-medium); margin-bottom: 8px;}
        .circuit p.connection-status strong.backup { color: #ff9800; }
        .circuit p.connection-status strong.offline { color: #f44336; }

        button {
            padding: 8px 15px; border: none; border-radius: 6px; color: white;
            cursor: pointer; font-size: 0.9em; font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        button:active { transform: translateY(0px); box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        button.toggle-power.on, button.toggle-device.on { background-color: var(--color-button-toggle-on); }
        button.toggle-power.off, button.toggle-device.off { background-color: var(--color-button-toggle-off); }
        button.remove-item { background-color: var(--color-button-remove); margin-left: 8px; }
        button.toggle-form-visibility { background-color: var(--color-button-neutral); width: 100%; margin-bottom: 15px; }

        /* --- POWER FLOW LINES --- */
        #linesContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        .flow-line {
            position: absolute; background-color: var(--color-line-inactive);
            z-index: 0; overflow: hidden; border-radius: 3px;
        }
        .flow-line::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            animation-duration: 1.8s; animation-iteration-count: infinite; animation-timing-function: linear;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .flow-line.active::before {
            opacity: 1;
        }

        .source-to-available-line { height: 8px; }
        .source-to-available-line.active::before {
            background: linear-gradient(to right, var(--color-source-line-gradient-start), var(--color-source-line-gradient-mid), var(--color-source-line-gradient-end));
            animation-name: flowHorizontalToCenter;
        }
        @keyframes flowHorizontalToCenter {
            0% { transform: translateX(-110%) scaleX(1); } 50% { transform: translateX(0%) scaleX(1.1); } 100% { transform: translateX(110%) scaleX(1); }
        }
        .available-to-circuit-line { height: 9px; }
        .available-to-circuit-line.active::before {
            background: linear-gradient(to right, var(--color-circuit-line-gradient-start), var(--color-circuit-line-gradient-mid), var(--color-circuit-line-gradient-end));
            animation-name: flowHorizontalToCircuit;
        }
         @keyframes flowHorizontalToCircuit {
            0% { transform: translateX(-110%); } 100% { transform: translateX(110%); }
        }
        /* --- END POWER FLOW LINES --- */

        .circuit-devices { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .device {
            background-color: var(--color-device-block-bg); border: 1px solid var(--color-device-block-border);
            border-radius: 6px; padding: 10px; text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.85em;
        }
        .device-icon { font-size: 20px; margin-bottom: 4px;}
        .device-name { font-weight: 500; margin-bottom: 4px; color: var(--color-device-title); }
        .device-power-stats { font-size: 0.8em; color: var(--color-text-medium); margin-bottom: 6px; font-weight: 500;}

        .switch { position: relative; display: inline-block; width: 45px; height: 25px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ffccbc; transition: .4s; border-radius: 25px; }
        .slider:before { position: absolute; content: ""; height: 17px; width: 17px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--color-button-toggle-on); }
        input:checked + .slider:before { transform: translateX(20px); }
        input:disabled + .slider { background-color: #e0e0e0; cursor: not-allowed; }
        input:disabled + .slider:before { background-color: #f0f0f0; }

        .controls-form { margin-top: 10px; padding: 15px; border-radius: 8px; display: none; flex-shrink: 0; }
        .controls-form.visible { display: block; }
        .controls-form h3 { text-align: center; font-size: 1.2em; margin-bottom: 15px;}
        .controls-form label, .controls-form input, .controls-form select { display: block; margin-bottom: 8px; width: calc(100% - 20px); font-size: 0.9em;}
        .controls-form input, .controls-form select { padding: 8px; border-radius: 6px; background-color: white;}
        .controls-form button { display: block; margin: 12px auto 0; }

        .add-power-source-controls { border: 1px dashed var(--color-source-panel-border); background-color: var(--color-source-panel-bg); opacity: 0.95; }
        .add-power-source-controls h3 { color: var(--color-source-title); }
        .add-power-source-controls input, .add-power-source-controls select { border: 1px solid var(--color-source-block-border); }
        #addPowerSourceBtn { background-color: var(--color-source-panel-border); color: var(--color-text-dark); }

        .add-circuit-controls { border: 1px dashed var(--color-circuit-panel-border); background-color: var(--color-circuit-panel-bg); opacity: 0.95;}
        .add-circuit-controls h3 { color: var(--color-circuit-title); }
        .add-circuit-controls input, .add-circuit-controls select { border: 1px solid var(--color-circuit-panel-border); }
        #addCircuitBtn { background-color: var(--color-circuit-panel-border); }

        .power-meter-total {
            margin-top: 20px; padding: 12px; background-color: #ede7f6;
            border-radius: 8px; text-align: center; border: 1px solid #d1c4e9;
            flex-shrink: 0;
        }
        .power-meter-total h3 { margin-top:0; margin-bottom: 6px; font-size: 1.1em; color: #512da8; }
        .meter-reading { font-size: 1.6em; font-weight: 700; color: #4527a0; }

    </style>
</head>
<body>
    <div id="linesContainer"></div>

    <div class="panel power-sources-panel">
        <h2>Energy Generation Units</h2>
        <button class="toggle-form-visibility" id="toggleAddSourceFormBtn">Show Add Unit Form</button>
        <div class="panel-content" id="powerSourcesList"></div>
        <div class="controls-form add-power-source-controls" id="addPowerSourceForm">
            <h3>Add New Generation Unit</h3>
            <label for="newSourceName">Unit Name:</label> <input type="text" id="newSourceName" placeholder="e.g., Solar Farm Alpha">
            <label for="newSourceType">Type:</label> <input type="text" id="newSourceType" placeholder="Cogen">
            <label for="newSourceCapacity">Capacity (W):</label> <input type="number" id="newSourceCapacity" placeholder="20000">
            <label for="newSourceIcon">Icon:</label> <input type="text" id="newSourceIcon" placeholder="⚙️">
            <label for="newSourceCO2">CO2 Emissions (g/kWh):</label> <input type="number" id="newSourceCO2" placeholder="e.g., 450">
            <button id="addPowerSourceBtn">Add Unit</button>
        </div>
    </div>

    <div class="panel power-available-panel" id="powerAvailablePanel">
        <h3>Total Available Capacity(Kresge Academic Building)</h3>
        <div class="meter-reading" id="totalAvailableValue">0.00 kW</div>
        <div class="capacity-owl-container">
            <span class="capacity-owl" id="capacityOwlEmoji">🦉</span>
            <p class="capacity-owl-status" id="capacityOwlText">Monitoring...</p>
        </div>
        <p class="description">Current combined output from active generation units.</p>
        <div class="co2-emissions-info">
            <h4>Hourly CO₂ Emissions</h4>
            <p id="co2EmissionsValue">Calculating...</p>
        </div>
        <button id="simulationModeBtn">Start Simulation Mode</button>
    </div>

    <div class="panel circuits-panel">
        <h2>Building Load Distribution</h2>
        <button class="toggle-form-visibility" id="toggleAddCircuitFormBtn">Show Add Zone Form</button>
        <div class="panel-content" id="circuitsList"></div>
        <div class="power-meter-total">
            <h3>Current Energy Consumption:</h3>
            <div id="totalMeterReading" class="meter-reading">0.00 kW</div>
        </div>
        <div class="controls-form add-circuit-controls" id="addCircuitForm">
            <h3>Configure New Load Zone</h3>
            <label for="newCircuitName">Zone Name:</label> <input type="text" id="newCircuitName" placeholder="e.g., HVAC Systems">
            <label for="newCircuitIcon">Zone Icon (Emoji):</label> <input type="text" id="newCircuitIcon" placeholder="🏢"> <!-- NEW -->
            <label for="newCircuitDeviceName">Device Name:</label> <input type="text" id="newCircuitDeviceName" placeholder="Main Chiller">
            <label for="newCircuitDeviceWatts">Device Wattage (W):</label> <input type="number" id="newCircuitDeviceWatts" placeholder="5000">
            <label for="connectToPrimarySource">Primary Feed:</label> <select id="connectToPrimarySource"></select>
            <label for="connectToBackupSource">Backup Feed:</label> <select id="connectToBackupSource"></select>
            <button id="addCircuitBtn">Add Zone</button>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT: Handles the dynamic behavior of the dashboard ---

        // DOM Element References
        const powerSourcesListEl = document.getElementById('powerSourcesList');
        const addPowerSourceBtn = document.getElementById('addPowerSourceBtn');
        const newSourceNameInput = document.getElementById('newSourceName');
        const newSourceTypeInput = document.getElementById('newSourceType');
        const newSourceCapacityInput = document.getElementById('newSourceCapacity');
        const newSourceIconInput = document.getElementById('newSourceIcon');
        const newSourceCO2Input = document.getElementById('newSourceCO2');
        const toggleAddSourceFormBtn = document.getElementById('toggleAddSourceFormBtn');
        const addPowerSourceForm = document.getElementById('addPowerSourceForm');

        const totalAvailableValueEl = document.getElementById('totalAvailableValue');
        const capacityOwlEmojiEl = document.getElementById('capacityOwlEmoji');
        const capacityOwlTextEl = document.getElementById('capacityOwlText');
        const co2EmissionsValueEl = document.getElementById('co2EmissionsValue');
        const simulationModeBtn = document.getElementById('simulationModeBtn');     // Button to toggle simulation mode

        const circuitsListEl = document.getElementById('circuitsList');
        const addCircuitBtn = document.getElementById('addCircuitBtn');
        const newCircuitNameInput = document.getElementById('newCircuitName');
        const newCircuitIconInput = document.getElementById('newCircuitIcon'); // NEW
        const newCircuitDeviceNameInput = document.getElementById('newCircuitDeviceName');
        const newCircuitDeviceWattsInput = document.getElementById('newCircuitDeviceWatts');
        const connectToPrimarySourceSelect = document.getElementById('connectToPrimarySource');
        const connectToBackupSourceSelect = document.getElementById('connectToBackupSource');
        const toggleAddCircuitFormBtn = document.getElementById('toggleAddCircuitFormBtn');
        const addCircuitForm = document.getElementById('addCircuitForm');
        const totalMeterReadingEl = document.getElementById('totalMeterReading');
        
        const linesContainer = document.getElementById('linesContainer');
        const powerAvailablePanel = document.getElementById('powerAvailablePanel');


        // --- DATA STORAGE ---
        let nextPowerSourceId = 1;
        let powerSources = [
            { id: 'ps' + nextPowerSourceId++, name: 'Cogen Unit', isOn: true, capacity: 85000, icon: '⚙️', type: 'Cogen', carbonFootprint: 'Medium', co2gPerkWh: 450 },
            { id: 'ps' + nextPowerSourceId++, name: 'Generator', isOn: false, capacity: 50000, icon: '🔋', type: 'Diesel Gen', carbonFootprint: 'High', co2gPerkWh: 750 },
           
        ];
        let nextCircuitId = 1; // Counter to generate unique IDs for circuits
        let circuits = [ // Array of circuit objects
            // Each object represents a circuit/zone with its properties:
            // id: unique identifier
            // name: display name of the zone
            // icon: emoji icon for the zone
            // primarySourceId: ID of the primary power source it's connected to
            // backupSourceId: ID of the backup power source
            // currentSourceId: ID of the source currently powering it (null if offline)
            // devices: array of device objects within this circuit
            //   - devId: unique ID for the device
            //   - name: display name of the device
            //   - icon: emoji icon for the device
            //   - watts: power consumption in Watts
            //   - isOn: boolean, true if device is on, false if off
            // element: (added dynamically) reference to its DOM element
            { id: 'c' + nextCircuitId++, name: 'Lecture hall', icon: '🖥️', primarySourceId: 'ps1', backupSourceId: 'ps2', currentSourceId: null, devices: [ 
                { devId: 'c1-d1', name: 'Lecture utilities ', icon: '🗄️', watts: 1800, isOn: true },
                
            ]},
            { id: 'c' + nextCircuitId++, name: 'Office Lighting', icon: '💡', primarySourceId: 'ps3', backupSourceId: 'ps1', currentSourceId: null, devices: [ 
                { devId: 'c2-d1', name: 'LED Grid', icon: '💡', watts: 3000, isOn: true } 
            ]},
            { id: 'c' + nextCircuitId++, name: 'General Outlets', icon: '🔌', primarySourceId: 'ps3', backupSourceId: 'ps1', currentSourceId: null, devices: [
                { devId: 'c3-d1', name: 'Wall Outlets Floor 1', icon: '🔌', watts: 1500, isOn: true },
                
            ]},
            { id: 'c' + nextCircuitId++, name: 'Elevator System', icon: '↕️', primarySourceId: 'ps1', backupSourceId: 'ps2', currentSourceId: null, devices: [
                { devId: 'c4-d1', name: 'Elevator', icon: '⚙️', watts: 10000, isOn: false },
            
            ]},
            { id: 'c' + nextCircuitId++, name: 'HVAC System', icon: '💨', primarySourceId: 'ps1', backupSourceId: 'ps2', currentSourceId: null, devices: [
                { devId: 'c5-d1', name: 'Main Heat Pump', icon: '🌡️', watts: 12000, isOn: false },
                { devId: 'c5-d2', name: 'Condensers', icon: '🌬️', watts: 2000, isOn: false }
            ]},
            { id: 'c' + nextCircuitId++, name: 'Office Computers', icon: '🔥', primarySourceId: 'ps1', backupSourceId: 'ps2', currentSourceId: null, devices: [
                { devId: 'c6-d1', name: 'Workstations(All)', icon: '🔥', watts: 10000, isOn: true }
            ]},
           
        
        ];

        // --- FUNCTIONS ---

        function setupFormToggles() {
            toggleAddSourceFormBtn.addEventListener('click', () => {
                addPowerSourceForm.classList.toggle('visible');
                toggleAddSourceFormBtn.textContent = addPowerSourceForm.classList.contains('visible') ? 'Hide Add Unit Form' : 'Show Add Unit Form';
            });
            toggleAddCircuitFormBtn.addEventListener('click', () => {
                addCircuitForm.classList.toggle('visible');
                toggleAddCircuitFormBtn.textContent = addCircuitForm.classList.contains('visible') ? 'Hide Add Zone Form' : 'Show Add Zone Form';
            });
        }

        function populateSourceSelects() {
            connectToPrimarySourceSelect.innerHTML = '<option value="">-- Select Primary --</option>';
            connectToBackupSourceSelect.innerHTML = '<option value="">-- Select Backup (Optional) --</option>';
            powerSources.forEach(source => {
                let optionP = document.createElement('option'); optionP.value = source.id; optionP.textContent = `${source.name} (${source.type})`;
                connectToPrimarySourceSelect.appendChild(optionP);
                let optionB = document.createElement('option'); optionB.value = source.id; optionB.textContent = `${source.name} (${source.type})`;
                connectToBackupSourceSelect.appendChild(optionB);
            });
        }

        function renderPowerSources() {
            powerSourcesListEl.innerHTML = '';
            powerSources.forEach(source => {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = `block power-source ${source.isOn ? '' : 'off'}`;
                sourceDiv.id = source.id;
                source.element = sourceDiv;

                const iconSpan = document.createElement('span'); iconSpan.className = 'power-source-icon'; iconSpan.textContent = source.icon || '⚡';
                const title = document.createElement('h3'); title.textContent = source.name;
                const capacityP = document.createElement('p'); capacityP.className = 'capacity-info'; capacityP.innerHTML = `Peak Capacity: <strong>${(source.capacity / 1000).toFixed(1)} kW</strong>`;
                const sustainP = document.createElement('p'); sustainP.className = 'sustainability-info'; sustainP.innerHTML = `Type: ${source.type} <br> Carbon: ${source.carbonFootprint || 'N/A'} (${source.co2gPerkWh}g/kWh)`;
                const statusP = document.createElement('p'); statusP.innerHTML = `Status: <strong>${source.isOn ? 'OPERATIONAL' : 'OFFLINE'}</strong>`;
                statusP.style.textAlign = "center"; statusP.style.color = source.isOn ? "var(--color-button-toggle-on)" : "var(--color-button-toggle-off)";
                const toggleBtn = document.createElement('button'); toggleBtn.textContent = source.isOn ? 'Deactivate' : 'Activate';
                toggleBtn.className = `toggle-power ${source.isOn ? 'on' : 'off'}`;
                toggleBtn.onclick = () => togglePowerSource(source.id); toggleBtn.style.cssText = 'display:block; margin:10px auto 5px;';
                const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove Unit';
                removeBtn.className = 'remove-item'; removeBtn.onclick = () => removePowerSource(source.id); removeBtn.style.cssText = 'display:block; margin:0 auto;';

                sourceDiv.append(iconSpan, title, capacityP, sustainP, statusP, toggleBtn, removeBtn);
                powerSourcesListEl.appendChild(sourceDiv);
            });
            populateSourceSelects();
            renderLines();
            renderTotalPowerAvailable();
        }

        function addNewPowerSource() {
            const name = newSourceNameInput.value.trim();
            const type = newSourceTypeInput.value.trim() || 'Generic';
            const capacity = parseInt(newSourceCapacityInput.value);
            const icon = newSourceIconInput.value.trim() || '⚡';
            const co2gPerkWh = parseFloat(newSourceCO2Input.value);

            if (!name) { alert('Unit Name is required.'); return; }
            if (isNaN(capacity) || capacity <= 0) { alert('Valid Peak Capacity (Watts) is required.'); return; }
            if (isNaN(co2gPerkWh) || co2gPerkWh < 0) { alert('Valid CO2 g/kWh value is required.'); return; }
            
            let carbonFootprintRating = 'N/A';
            if (co2gPerkWh <= 50) carbonFootprintRating = 'Very Low';
            else if (co2gPerkWh <= 200) carbonFootprintRating = 'Low';
            else if (co2gPerkWh <= 500) carbonFootprintRating = 'Medium';
            else if (co2gPerkWh <= 800) carbonFootprintRating = 'High';
            else carbonFootprintRating = 'Very High';

            powerSources.push({
                id: 'ps' + nextPowerSourceId++, name: name, isOn: false, capacity: capacity, icon: icon,
                type: type, carbonFootprint: carbonFootprintRating, co2gPerkWh: co2gPerkWh
            });
            newSourceNameInput.value = ''; newSourceTypeInput.value = ''; newSourceCapacityInput.value = '';
            newSourceIconInput.value = ''; newSourceCO2Input.value = '';
            renderPowerSources();
            updateCircuitPowerAndDeviceStates();
        }
        addPowerSourceBtn.addEventListener('click', addNewPowerSource);

        function removePowerSource(sourceIdToRemove) {
            if (!confirm('Remove this generation unit? Connected load zones may lose power or switch to backup.')) return;
            powerSources = powerSources.filter(ps => ps.id !== sourceIdToRemove);
            circuits.forEach(circuit => {
                if (circuit.primarySourceId === sourceIdToRemove) circuit.primarySourceId = null;
                if (circuit.backupSourceId === sourceIdToRemove) circuit.backupSourceId = null;
            });
            renderPowerSources(); renderCircuits();
        }

        function renderTotalPowerAvailable() {
            let totalAvailable = 0;
            powerSources.forEach(source => { if (source.isOn) totalAvailable += source.capacity; });
            totalAvailableValueEl.textContent = `${(totalAvailable / 1000).toFixed(2)} kW`;
            updateCapacityOwl(totalAvailable);
        }

        function updateCapacityOwl(currentAvailableCapacity) {
            let consumedPower = 0;
            circuits.forEach(circuit => {
                if (circuit.currentSourceId) {
                    circuit.devices.forEach(device => {
                        if (device.isOn) consumedPower += device.watts;
                    });
                }
            });

            let utilization = 0;
            if (currentAvailableCapacity > 0) {
                utilization = (consumedPower / currentAvailableCapacity) * 100;
            } else if (consumedPower > 0) {
                utilization = 101;
            }

            let owlEmoji = '🙂'; let owlText = 'Monitoring...'; let owlTransform = 'scale(1)';
            if (utilization <= 5) {
                owlEmoji = '🙂'; owlText = 'Relaxed';
                if (currentAvailableCapacity === 0 && consumedPower === 0) { owlEmoji = '😴'; owlText = 'System Off';}
            } else if (utilization <= 50) {
                owlEmoji = '😀'; owlText = 'Working Steadily'; owlTransform = 'scale(1.05) translateY(-2px)';
            } else if (utilization <= 90) {
                owlEmoji = '😅'; owlText = 'Working Hard!'; owlTransform = 'scale(1.1) translateY(-4px) rotate(2deg)';
            } else {
                owlEmoji = '🥵'; owlText = utilization > 100 ? 'Overloaded!' : 'Near Max Capacity!';
                owlTransform = 'scale(1.15) translateY(-5px) rotate(-3deg)';
            }
            capacityOwlEmojiEl.textContent = owlEmoji;
            capacityOwlTextEl.textContent = owlText;
            capacityOwlEmojiEl.style.transform = owlTransform;
        }

        function renderCircuits() {
            circuitsListEl.innerHTML = '';
            circuits.forEach(circuit => {
                const circuitDiv = document.createElement('div');
                circuitDiv.className = 'block circuit'; circuitDiv.id = circuit.id;
                circuit.element = circuitDiv;

                // Create header container for icon and title
                const headerDiv = document.createElement('div');
                headerDiv.className = 'circuit-header';

                const iconSpan = document.createElement('span');
                iconSpan.className = 'circuit-icon';
                iconSpan.textContent = circuit.icon || '🏢'; // Default building emoji if none

                const title = document.createElement('h3');
                title.textContent = circuit.name;

                headerDiv.append(iconSpan, title); // Add icon and title to header

                const connectionP = document.createElement('p'); connectionP.className = 'connection-status';
                const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove Zone';
                removeBtn.className = 'remove-item'; removeBtn.onclick = () => removeCircuit(circuit.id);
                removeBtn.style.display = 'block'; removeBtn.style.margin = '10px auto 0';

                const devicesContainer = document.createElement('div'); devicesContainer.className = 'circuit-devices';
                circuit.devices.forEach(device => {
                    const deviceDiv = document.createElement('div'); deviceDiv.className = 'device'; deviceDiv.dataset.watts = device.watts;
                    const iconDiv = document.createElement('div'); iconDiv.className = 'device-icon'; iconDiv.textContent = device.icon || '🔌';
                    const deviceNameDiv = document.createElement('div'); deviceNameDiv.className = 'device-name'; deviceNameDiv.textContent = device.name;
                    const powerStatsDiv = document.createElement('div'); powerStatsDiv.className = 'device-power-stats'; powerStatsDiv.textContent = `${device.watts}W Load`;
                    const switchLabel = document.createElement('label'); switchLabel.className = 'switch';
                    const switchInput = document.createElement('input'); switchInput.type = 'checkbox'; switchInput.className = 'device-switch';
                    switchInput.checked = device.isOn;
                     // Store device and circuit ID on the switch for easier access in simulation mode
                    switchInput.dataset.deviceId = device.devId;
                    switchInput.dataset.circuitId = circuit.id;

                    switchInput.onchange = () => { device.isOn = switchInput.checked; updateCircuitPowerAndDeviceStates(); };
                    const sliderSpan = document.createElement('span'); sliderSpan.className = 'slider';
                    switchLabel.append(switchInput, sliderSpan);
                    deviceDiv.append(iconDiv, deviceNameDiv, powerStatsDiv, switchLabel);
                    devicesContainer.appendChild(deviceDiv);
                });
                circuitDiv.append(headerDiv, connectionP, devicesContainer, removeBtn); // Use headerDiv
                circuitsListEl.appendChild(circuitDiv);
            });
            renderLines();
            updateCircuitPowerAndDeviceStates();
        }
        
        function renderLines() {
            linesContainer.innerHTML = '';
            if (!powerAvailablePanel) return;
            const availablePanelRect = powerAvailablePanel.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();

            powerSources.forEach(source => {
                if (!source.element) return;
                const sourceRect = source.element.getBoundingClientRect();
                const line = document.createElement('div');
                line.className = 'flow-line source-to-available-line';
                if (source.isOn) line.classList.add('active');
                linesContainer.appendChild(line);
                const lineHeight = parseFloat(getComputedStyle(line).height);
                const startX = sourceRect.right - bodyRect.left; const startY = sourceRect.top - bodyRect.top + sourceRect.height / 2;
                const endX = availablePanelRect.left - bodyRect.left;
                line.style.left = `${startX - 5}px`; line.style.top = `${startY - (lineHeight / 2)}px`; line.style.width = `${(endX - startX) + 10}px`;
            });

            circuits.forEach(circuit => {
                if (!circuit.element || !circuit.currentSourceId) return;
                const isAnyDeviceOn = circuit.devices.some(d => d.isOn);
                const circuitRect = circuit.element.getBoundingClientRect();
                const line = document.createElement('div');
                line.className = 'flow-line available-to-circuit-line';
                if (circuit.currentSourceId && isAnyDeviceOn) line.classList.add('active');
                linesContainer.appendChild(line);
                const lineHeight = parseFloat(getComputedStyle(line).height);
                const startX = availablePanelRect.right - bodyRect.left;
                const endX = circuitRect.left - bodyRect.left;
                line.style.left = `${startX - 5}px`;
                line.style.top = `${circuitRect.top - bodyRect.top + circuitRect.height / 2 - (lineHeight / 2)}px`;
                line.style.width = `${(endX - startX) + 10}px`;
            });
        }

        function togglePowerSource(sourceId) {
            const source = powerSources.find(ps => ps.id === sourceId);
            if (source) {
                source.isOn = !source.isOn;
                if(source.element) {
                    source.element.classList.toggle('off', !source.isOn);
                    const statusP = source.element.querySelector('.sustainability-info + p');
                    if (statusP) statusP.innerHTML = `Status: <strong>${source.isOn ? 'OPERATIONAL' : 'OFFLINE'}</strong>`;
                    const toggleBtn = source.element.querySelector('.toggle-power');
                    if (toggleBtn) {
                        toggleBtn.textContent = source.isOn ? 'Deactivate' : 'Activate';
                        toggleBtn.classList.toggle('on', source.isOn); toggleBtn.classList.toggle('off', !source.isOn);
                    }
                }
                renderTotalPowerAvailable();
                updateCircuitPowerAndDeviceStates();
            }
        }

        function updateCircuitPowerAndDeviceStates() {
            let totalConsumedWatts = 0;
            circuits.forEach(circuit => {
                let poweringSource = null; let connectionText = 'Offline'; let connectionClass = 'offline';
                const primary = powerSources.find(ps => ps.id === circuit.primarySourceId);
                if (primary && primary.isOn) { poweringSource = primary; connectionText = `Online (Primary: ${primary.name})`; connectionClass = 'primary'; }
                else {
                    const backup = powerSources.find(ps => ps.id === circuit.backupSourceId);
                    if (backup && backup.isOn) { poweringSource = backup; connectionText = `Online (<strong class="backup">Backup: ${backup.name}</strong>)`; connectionClass = 'backup';}
                }
                circuit.currentSourceId = poweringSource ? poweringSource.id : null;
                const isCircuitActuallyPowered = !!poweringSource;

                if (circuit.element) {
                    circuit.element.classList.toggle('powered', isCircuitActuallyPowered);
                    const deviceSwitches = circuit.element.querySelectorAll('.device-switch');
                    deviceSwitches.forEach(sw => sw.disabled = !isCircuitActuallyPowered);
                    const connectionP = circuit.element.querySelector('p.connection-status');
                    if (connectionP) connectionP.innerHTML = `Feed Status: <strong class="${connectionClass}">${connectionText}</strong>`;
                    if(isCircuitActuallyPowered) { circuit.devices.forEach(device => { if (device.isOn) totalConsumedWatts += device.watts; }); }
                }
            });
            updateTotalPowerConsumption(totalConsumedWatts);
            renderLines();
            calculateAndDisplayCO2Emissions();
        }
        
        function updateTotalPowerConsumption(currentConsumption = 0) {
            totalMeterReadingEl.textContent = `${(currentConsumption / 1000).toFixed(2)} kW`;
            let totalAvailable = 0;
            powerSources.forEach(source => { if (source.isOn) totalAvailable += source.capacity; });
            updateCapacityOwl(totalAvailable);
        }

        function calculateAndDisplayCO2Emissions() {
            let totalCO2gPerHour = 0;
            circuits.forEach(circuit => {
                if (circuit.currentSourceId) {
                    const poweringSource = powerSources.find(ps => ps.id === circuit.currentSourceId);
                    if (poweringSource && typeof poweringSource.co2gPerkWh === 'number') {
                        let circuitLoadWatts = 0;
                        circuit.devices.forEach(device => {
                            if (device.isOn) {
                                circuitLoadWatts += device.watts;
                            }
                        });
                        if (circuitLoadWatts > 0) {
                            const circuitLoadKWh = circuitLoadWatts / 1000.0;
                            totalCO2gPerHour += circuitLoadKWh * poweringSource.co2gPerkWh;
                        }
                    }
                }
            });
            if (totalCO2gPerHour >= 1000) {
                co2EmissionsValueEl.textContent = `${(totalCO2gPerHour / 1000).toFixed(2)} kg CO₂/hr`;
            } else {
                co2EmissionsValueEl.textContent = `${totalCO2gPerHour.toFixed(1)} g CO₂/hr`;
            }
        }

        function addNewCircuit() {
            const name = newCircuitNameInput.value.trim();
            const icon = newCircuitIconInput.value.trim() || '🏢'; // Get icon, default 🏢
            const deviceName = newCircuitDeviceNameInput.value.trim() || 'Default Device';
            const deviceWatts = parseInt(newCircuitDeviceWattsInput.value);
            const primaryId = connectToPrimarySourceSelect.value;
            const backupId = connectToBackupSourceSelect.value;

            if (!name) { alert('Zone Name is required.'); return; }
            if (isNaN(deviceWatts) || deviceWatts <= 0) { alert('Valid Initial Device Wattage is required.'); return; }
            if (primaryId && backupId && primaryId === backupId) { alert('Primary and Backup sources cannot be the same.'); return; }
            
            const newDevId = `c${nextCircuitId}-d1`;
            circuits.push({
                id: 'c' + nextCircuitId++,
                name: name,
                icon: icon, // Store icon
                primarySourceId: primaryId || null,
                backupSourceId: backupId || null,
                currentSourceId: null,
                devices: [ { devId: newDevId, name: deviceName, icon: '⚡', watts: deviceWatts, isOn: false } ]
            });
            newCircuitNameInput.value = '';
            newCircuitIconInput.value = ''; // Clear icon input
            newCircuitDeviceNameInput.value = '';
            newCircuitDeviceWattsInput.value = '';
            connectToPrimarySourceSelect.value = '';
            connectToBackupSourceSelect.value = '';
            renderCircuits();
        }
        addCircuitBtn.addEventListener('click', addNewCircuit);

        function removeCircuit(circuitIdToRemove) {
            if (!confirm('Remove this load zone configuration?')) return;
            circuits = circuits.filter(c => c.id !== circuitIdToRemove); renderCircuits();
        }

        function debounce(func, wait) {
            let timeout; return (...args) => { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); };
        }
        const debouncedRenderLines = debounce(renderLines, 100);
        window.addEventListener('resize', debouncedRenderLines);

           // --- SIMULATION MODE ---
        // This section handles the logic for the random simulation mode.

        let isSimulationModeActive = false; // Flag to track if simulation is running
        let simulationZoneIntervalId = null;  // To store the interval ID for zone simulation
        let simulationGeneratorIntervalId = null; // To store the interval ID for generator simulation

        const SIMULATION_ZONE_TOGGLE_CHANCE = 0.3; // 30% chance a circuit's devices will be considered for toggling
        const SIMULATION_DEVICE_ON_CHANCE = 0.5;   // 50% chance a device (in a chosen circuit) will be turned on
        const SIMULATION_GENERATOR_ACTIVE_PROBABILITY = 0.85; // 85% chance a generator will be set to ON

        /**
         * Function executed by the zone simulation timer.
         * Randomly toggles the 'isOn' state of devices within circuits.
         */
        function simulateZoneChanges() {
            if (!isSimulationModeActive) return; // Do nothing if simulation is off

            console.log("SIM: Simulating zone device changes...");
            circuits.forEach(circuit => {
                // Only consider toggling devices if the circuit itself is currently powered
                // and a random chance passes
                if (circuit.currentSourceId && Math.random() < SIMULATION_ZONE_TOGGLE_CHANCE) {
                    circuit.devices.forEach(device => {
                        // For each device in the chosen circuit, randomly set its state
                        device.isOn = Math.random() < SIMULATION_DEVICE_ON_CHANCE;
                    });
                }
            });
            // After changing device states in data, update the entire UI
            // This will re-render switches, update consumption, lines, CO2, owl, etc.
            updateCircuitPowerAndDeviceStates();
        }

        /**
         * Function executed by the generator simulation timer.
         * Randomly sets the 'isOn' state of power generators.
         */
        function simulateGeneratorChanges() {
            if (!isSimulationModeActive) return; // Do nothing if simulation is off

            console.log("SIM: Simulating generator state changes...");
            let changed = false;
            powerSources.forEach(source => {
                // For each source, decide its new state based on the active probability
                const shouldBeOn = Math.random() < SIMULATION_GENERATOR_ACTIVE_PROBABILITY;
                if (source.isOn !== shouldBeOn) {
                    source.isOn = shouldBeOn; // Directly update the data model
                    changed = true;
                }
            });

            if (changed) {
                // If any generator states were changed in the data:
                // 1. Re-render the power sources panel to show their new visual states (on/off, button text).
                renderPowerSources(); 
                // 2. Update circuits based on these new generator states. This handles everything else:
                //    circuit connection status, device switch enabling/disabling, consumption, lines, CO2, owl.
                updateCircuitPowerAndDeviceStates();
            }
        }

        /**
         * Toggles the simulation mode on or off.
         * Starts or stops the simulation timers.
         */
        function toggleSimulationMode() {
            isSimulationModeActive = !isSimulationModeActive; // Flip the active flag

            if (isSimulationModeActive) {
                console.log("SIM: Simulation Mode STARTED");
                simulationModeBtn.textContent = 'Stop Simulation Mode';
                simulationModeBtn.style.backgroundColor = 'var(--color-button-toggle-off)'; // Red when active

                // Start the zone device simulation timer (every 10 seconds)
                simulationZoneIntervalId = setInterval(simulateZoneChanges, 500);
                // Start the generator state simulation timer (every 30 seconds)
                simulationGeneratorIntervalId = setInterval(simulateGeneratorChanges, 1000);

                // Optionally, run them once immediately
                simulateZoneChanges();
                simulateGeneratorChanges();

            } else {
                console.log("SIM: Simulation Mode STOPPED");
                simulationModeBtn.textContent = 'Start Simulation Mode';
                simulationModeBtn.style.backgroundColor = 'var(--color-button-simulation)'; // Orange when inactive

                // Clear (stop) the simulation timers
                clearInterval(simulationZoneIntervalId);
                clearInterval(simulationGeneratorIntervalId);
                simulationZoneIntervalId = null;
                simulationGeneratorIntervalId = null;
            }
        }
        // Attach event listener to the simulation mode button
        simulationModeBtn.addEventListener('click', toggleSimulationMode);

        // --- END SIMULATION MODE ---


        // --- INITIALIZATION ---
        setupFormToggles();
        renderPowerSources(); 
        renderCircuits();
    </script>
</body>
</html>